#!/usr/bin/env python3
"""
SerialCom - Graphical interface for serial communication via picocom
Version: 1.0
"""

import sys
import os
import subprocess
import glob
from PyQt6.QtWidgets import (
    QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
    QLabel, QComboBox, QPushButton, QGroupBox, QFormLayout, QMessageBox
)
from PyQt6.QtCore import Qt, QSize, QRect, QPoint
from PyQt6.QtGui import QFont, QPalette, QColor, QPixmap, QIcon, QPainter, QPolygon

# Application version
VERSION = "1.0"

try:
    from PyQt6.QtSerialPort import QSerialPortInfo
    SERIAL_PORT_AVAILABLE = True
except ImportError:
    SERIAL_PORT_AVAILABLE = False


class SerialTerminalGUI(QMainWindow):
    def __init__(self):
        super().__init__()
        self.setWindowTitle(f"SerialCom v{VERSION}")
        self.setFixedSize(550, 600)
        self.init_ui()
        self.apply_styles()

    def init_ui(self):
        """Initialize the user interface"""
        # Central widget
        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        # Main layout
        main_layout = QVBoxLayout()
        main_layout.setSpacing(15)
        main_layout.setContentsMargins(20, 20, 20, 20)

        # Port configuration group
        port_group = QGroupBox("Port Configuration")
        port_layout = QFormLayout()
        port_layout.setVerticalSpacing(15)
        port_layout.setContentsMargins(10, 15, 10, 10)

        # Port type
        self.port_type = QComboBox()
        self.port_type.addItems(['Serial (/dev/ttyS*)', 'USB (/dev/ttyUSB*)', 'All Ports'])
        self.port_type.setCurrentIndex(1)
        self.port_type.currentIndexChanged.connect(self.update_port_list)
        port_layout.addRow("Port Type:", self.port_type)

        # Specific port
        self.port = QComboBox()
        port_layout.addRow("Port:", self.port)

        port_group.setLayout(port_layout)
        main_layout.addWidget(port_group)

        # Communication parameters group
        comm_group = QGroupBox("Communication Parameters")
        comm_layout = QFormLayout()
        comm_layout.setVerticalSpacing(15)
        comm_layout.setContentsMargins(10, 15, 10, 10)

        # Baud Rate - MAIN FIELD
        velocity_label = QLabel("Baud Rate:")
        velocity_font = QFont("Sans Serif", 10, QFont.Weight.Bold)
        velocity_label.setFont(velocity_font)

        self.baudrate = QComboBox()
        self.baudrate.addItems([
            '300', '1200', '2400', '4800', '9600', '19200',
            '38400', '57600', '115200', '230400', '460800', '921600'
        ])
        self.baudrate.setCurrentText('9600')
        comm_layout.addRow(velocity_label, self.baudrate)

        # Data bits
        self.databits = QComboBox()
        self.databits.addItems(['5', '6', '7', '8'])
        self.databits.setCurrentText('8')
        comm_layout.addRow("Data Bits:", self.databits)

        # Parity
        self.parity = QComboBox()
        self.parity.addItems(['None', 'Even', 'Odd'])
        self.parity.setCurrentText('None')
        comm_layout.addRow("Parity:", self.parity)

        # Stop bits
        self.stopbits = QComboBox()
        self.stopbits.addItems(['1', '2'])
        self.stopbits.setCurrentText('1')
        comm_layout.addRow("Stop Bits:", self.stopbits)

        # Flow control
        self.flow = QComboBox()
        self.flow.addItems(['None', 'Hardware (RTS/CTS)', 'Software (XON/XOFF)'])
        self.flow.setCurrentText('None')
        comm_layout.addRow("Flow Control:", self.flow)

        comm_group.setLayout(comm_layout)
        main_layout.addWidget(comm_group)

        # Connect button
        self.connect_btn = QPushButton("CONNECT")
        self.connect_btn.setMinimumHeight(45)
        self.connect_btn.setFont(QFont("Sans Serif", 11, QFont.Weight.Bold))
        self.connect_btn.clicked.connect(self.connect)
        main_layout.addWidget(self.connect_btn)

        # Status
        self.status_label = QLabel("Ready to connect")
        self.status_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.status_label.setStyleSheet("color: #a6e3a1; font-size: 10pt; padding: 5px;")
        main_layout.addWidget(self.status_label)

        central_widget.setLayout(main_layout)

        # Update port list
        self.update_port_list()

    def apply_styles(self):
        """Apply modern light theme to the application"""
        self.setStyleSheet("""
            QMainWindow {
                background-color: #f5f5f5;
            }
            QGroupBox {
                font-weight: bold;
                border: 2px solid #d0d0d0;
                border-radius: 8px;
                margin-top: 10px;
                padding-top: 15px;
                background-color: #ffffff;
                color: #2c2c2c;
            }
            QGroupBox::title {
                subcontrol-origin: margin;
                left: 10px;
                padding: 0 5px;
                color: #5a5a5a;
            }
            QComboBox {
                border: 2px solid #d0d0d0;
                border-radius: 6px;
                padding: 6px 28px 6px 10px;
                background-color: #ffffff;
                min-height: 28px;
                color: #2c2c2c;
                font-size: 10pt;
            }
            QComboBox::drop-down {
                subcontrol-origin: padding;
                subcontrol-position: top right;
                width: 25px;
                border-left: 1px solid #d0d0d0;
                border-top-right-radius: 5px;
                border-bottom-right-radius: 5px;
                background-color: transparent;
            }
            QComboBox::down-arrow {
                image: url(""" + os.path.join(os.path.dirname(__file__), "arrow_down.svg") + """);
                width: 12px;
                height: 12px;
            }
            QComboBox:hover {
                border: 2px solid #a0a0a0;
                background-color: #fafafa;
            }
            QComboBox:focus {
                border: 2px solid #808080;
            }
            QComboBox QAbstractItemView {
                border: 2px solid #d0d0d0;
                background-color: #ffffff;
                selection-background-color: #e0e0e0;
                selection-color: #2c2c2c;
                color: #2c2c2c;
                padding: 4px;
                outline: none;
            }
            QPushButton {
                background-color: #4caf50;
                color: #ffffff;
                border: none;
                border-radius: 8px;
                padding: 12px;
                font-weight: bold;
                font-size: 11pt;
            }
            QPushButton:hover {
                background-color: #45a049;
            }
            QPushButton:pressed {
                background-color: #3d8b40;
            }
            QLabel {
                color: #2c2c2c;
            }
            QFormLayout QLabel {
                color: #4a4a4a;
            }
        """)

    def update_port_list(self):
        """Update the list of available ports"""
        self.port.clear()

        port_type = self.port_type.currentText()
        ports = []

        if SERIAL_PORT_AVAILABLE and 'All' in port_type:
            # Use QSerialPortInfo to detect all ports
            available_ports = QSerialPortInfo.availablePorts()
            ports = [port.portName() for port in available_ports]
            ports = [f"/dev/{p}" for p in ports]
        else:
            # Use glob to search for ports
            if 'Serial' in port_type:
                pattern = '/dev/ttyS*'
            elif 'USB' in port_type:
                pattern = '/dev/ttyUSB*'
            else:  # All
                ports_s = sorted(glob.glob('/dev/ttyS*'))
                ports_usb = sorted(glob.glob('/dev/ttyUSB*'))
                ports = ports_s + ports_usb

            if not ports:
                ports = sorted(glob.glob(pattern))

        if ports:
            self.port.addItems(ports)
            self.status_label.setText(f"{len(ports)} port(s) found")
            self.status_label.setStyleSheet("color: #a6e3a1; font-size: 10pt; padding: 5px;")
        else:
            self.port.addItem("No ports found")
            self.status_label.setText("No serial ports available")
            self.status_label.setStyleSheet("color: #fab387; font-size: 10pt; padding: 5px;")

    def build_picocom_command(self):
        """Build the picocom command with configured parameters"""
        port = self.port.currentText()

        if 'No ports found' in port or not port:
            return None

        baudrate = self.baudrate.currentText()
        databits = self.databits.currentText()

        # Parity
        parity_map = {'None': 'n', 'Even': 'e', 'Odd': 'o'}
        parity = parity_map[self.parity.currentText()]

        stopbits = self.stopbits.currentText()

        # Flow control
        flow_type = self.flow.currentText()
        if 'Hardware' in flow_type:
            flow = 'h'
        elif 'Software' in flow_type:
            flow = 's'
        else:
            flow = 'n'

        # Picocom command
        cmd = [
            'picocom',
            '-b', baudrate,
            '-d', databits,
            '-p', parity,
            '-f', flow,
            port
        ]

        # Add stop bits if 2
        if stopbits == '2':
            cmd.insert(-1, '-y')
            cmd.insert(-1, '2')

        return cmd

    def connect(self):
        """Connect to the serial port using picocom"""
        # Check if picocom is installed
        try:
            subprocess.run(['which', 'picocom'], check=True, capture_output=True)
        except subprocess.CalledProcessError:
            QMessageBox.critical(
                self,
                "Error",
                "picocom is not installed.\n\n"
                "Install with:\nsudo pacman -S picocom"
            )
            return

        # Build command
        cmd = self.build_picocom_command()

        if not cmd:
            QMessageBox.warning(
                self,
                "Warning",
                "Select a valid serial port"
            )
            return

        self.status_label.setText("Connecting...")
        self.status_label.setStyleSheet("color: #fab387; font-size: 10pt; padding: 5px;")
        QApplication.processEvents()

        # Determine default terminal
        terminals = [
            'gnome-terminal',
            'konsole',
            'xfce4-terminal',
            'kitty',
            'alacritty',
            'xterm'
        ]

        terminal_cmd = None
        for term in terminals:
            try:
                subprocess.run(['which', term], check=True, capture_output=True)
                terminal_cmd = term
                break
            except subprocess.CalledProcessError:
                continue

        if not terminal_cmd:
            QMessageBox.critical(
                self,
                "Error",
                "No terminal found on the system.\n\n"
                "Install a terminal like:\n"
                "sudo pacman -S gnome-terminal"
            )
            self.status_label.setText("Error: terminal not found")
            self.status_label.setStyleSheet("color: #f38ba8; font-size: 10pt; padding: 5px;")
            return

        # Build full command with sudo
        picocom_cmd_str = ' '.join(cmd)

        # Terminal-specific commands
        if terminal_cmd == 'gnome-terminal':
            full_cmd = [terminal_cmd, '--', 'bash', '-c',
                       f'sudo {picocom_cmd_str}; echo "\nPress Enter to close..."; read']
        elif terminal_cmd == 'konsole':
            full_cmd = [terminal_cmd, '-e', 'bash', '-c',
                       f'sudo {picocom_cmd_str}; echo "\nPress Enter to close..."; read']
        elif terminal_cmd in ['xfce4-terminal', 'xterm']:
            full_cmd = [terminal_cmd, '-e', 'bash', '-c',
                       f'sudo {picocom_cmd_str}; echo "\nPress Enter to close..."; read']
        else:  # kitty, alacritty
            full_cmd = [terminal_cmd, 'bash', '-c',
                       f'sudo {picocom_cmd_str}; echo "\nPress Enter to close..."; read']

        try:
            subprocess.Popen(full_cmd)
            self.status_label.setText("Terminal opened - enter root password")
            self.status_label.setStyleSheet("color: #89b4fa; font-size: 10pt; padding: 5px;")

            # Show connection information
            QMessageBox.information(
                self,
                "Connection Started",
                f"Picocom terminal opened.\n\n"
                f"Port: {self.port.currentText()}\n"
                f"Baud Rate: {self.baudrate.currentText()} baud\n"
                f"Configuration: {self.databits.currentText()}{self.parity.currentText()[0]}{self.stopbits.currentText()}\n\n"
                f"Use Ctrl+A Ctrl+X to exit picocom"
            )
        except Exception as e:
            QMessageBox.critical(
                self,
                "Error",
                f"Error opening terminal:\n{str(e)}"
            )
            self.status_label.setText("Connection error")
            self.status_label.setStyleSheet("color: #f38ba8; font-size: 10pt; padding: 5px;")


def main():
    app = QApplication(sys.argv)

    # Set default font
    font = QFont("Sans Serif", 9)
    app.setFont(font)

    window = SerialTerminalGUI()
    window.show()

    sys.exit(app.exec())


if __name__ == '__main__':
    main()
